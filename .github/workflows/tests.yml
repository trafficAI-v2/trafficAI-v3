name: Tests

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main ]

jobs:
  test-python:
    name: Python æ¸¬è©¦
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11]

    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ è¨­ç½® Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ å®‰è£ä¾è³´
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        # å®‰è£å°ˆæ¡ˆä¾è³´ (è·³éå¯èƒ½çš„éŒ¯èª¤)
        if [ -f requirements-dev.txt ]; then
          pip install -r requirements-dev.txt || echo "è·³éé–‹ç™¼ä¾è³´"
        fi
        if [ -f detect_API/requirements.txt ]; then
          pip install -r detect_API/requirements.txt || echo "è·³é detect_API ä¾è³´"
        fi
        if [ -f web_api/requirements.txt ]; then
          pip install -r web_api/requirements.txt || echo "è·³é web_api ä¾è³´"
        fi

    - name: ğŸ§ª åŸ·è¡Œ Flake8 æª¢æŸ¥
      run: |
        # åœæ­¢æ§‹å»ºå¦‚æœæœ‰Pythonèªæ³•éŒ¯èª¤æˆ–æœªå®šç¾©çš„åç¨±
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=traffic-system/
        # é€€å‡ºé›¶ä½†è¦–ç‚ºè­¦å‘Š
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude=traffic-system/

  test-frontend:
    name: å‰ç«¯æ¸¬è©¦
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
      uses: actions/checkout@v4

    - name: ğŸ“¦ è¨­ç½® Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: traffic-system/package-lock.json

    - name: ğŸ“¦ å®‰è£ä¾è³´
      working-directory: ./traffic-system
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi

    - name: ğŸ§ª åŸ·è¡Œ Lint æª¢æŸ¥
      working-directory: ./traffic-system
      run: npm run lint

    - name: ğŸ—ï¸ æ¸¬è©¦æ§‹å»º
      working-directory: ./traffic-system
      run: npm run build

    - name: ğŸ§ª åŸ·è¡Œæ¸¬è©¦ (å¦‚æœå­˜åœ¨)
      working-directory: ./traffic-system
      run: npm run test --if-present